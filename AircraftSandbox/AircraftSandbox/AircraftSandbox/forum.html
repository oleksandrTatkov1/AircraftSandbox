<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../AircraftSandbox/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Londrina+Shadow&family=Londrina+Solid:wght@100;300;400;900&family=M+PLUS+Rounded+1c&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <link rel="stylesheet" href="../AircraftSandbox/css/scrollForumStyle.css">
</head>
<body>
    <div class="page-wrapper">
        <header class="header">
            <div class="container header__container">
                <div class="header__logo">
                    <img src="../AircraftSandbox/img/index/header/logo_black.png" alt="logo" class="header__imgL">
                </div>
                <div class="header__menu">
                    <nav class="header__nav nav">
                      <ul class="nav__list">
                        <li class="nav__item"><a href="index.html" class="nav__link">–ì–æ–ª–æ–≤–Ω–∞</a></li>
                        <li class="nav__item"><a href="forum.html" class="nav__link">–§–æ—Ä—É–º</a></li>
                        <li class="nav__item"><a href="routes.html" class="nav__link">–ú–∞—Ä—à—Ä—É—Ç–∏ –ø–æ–ª—å–æ—Ç—ñ–≤</a></li>
                        <li class="nav__item"><a href="apk.html" class="nav__link">–î–æ–¥–∞—Ç–∫–æ–≤—ñ APK</a></li>
                        <li class="nav__item">
                          <input type="checkbox" id="dropItem" class="dropdown-toggle">
                          <label for="dropItem" class="dropdown-label">–î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–µ—Å—É—Ä—Å–∏ <span class="arrow">‚ñº</span></label>
                          <ul class="dropdown-menu">
                            <li class="dropdown-item"><a href="https://t.me/SkyTechDev_bot">–ü—ñ–¥—Ç—Ä–∏–º–∫–∞</a></li>
                            <li class="dropdown-item"><a href="guides.html">–¢—É—Ç–æ—Ä—ñ–∞–ª–∏</a></li>
                          </ul>
                        </li>
                      </ul>
                    </nav>
                    <div class="header__registration">
                        <div class="header__profile" id="user-profile">
                            <a href="/AircraftSandbox/AircraftSandbox/AircraftSandbox/AircraftSandbox/profile.html">
                                <img id="header-avatar" src="/AircraftSandbox/img/index/header/free-icon-user-483361.png" alt="–ü—Ä–æ—Ñ—ñ–ª—å" class="profile-icon" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                            </a>
                        </div>
                    </div>
                </div>
                <div class="menu-btn">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </header>
        <main class="main">
            <div class="container">
                <section class="create-post scroll-section">
                    <h2 class="create-post__title">–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—é</h2>
                    <form class="create-post__form" enctype="multipart/form-data">
                        <textarea
                            name="header"              
                            class="create-post__namearea"
                            placeholder="–ù–∞–∑–≤–∞..."
                            required
                        ></textarea>
                        <textarea
                            name="content"           
                            class="create-post__textarea"
                            placeholder="–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è–º–∏‚Ä¶"
                            required
                        ></textarea>
                        <div class="create-post__actions">
                            <label class="file-label">
                            üìé –î–æ–¥–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                            <input
                                type="file"
                                name="image"           
                                class="create-post__file"
                                accept="image/*"
                            >
                            </label>
                            <button type="submit" class="create-post__submit">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
                        </div>
                    </form>
                </section>
                <div class="posts-container">
            </div>
        </main>        
        <footer class="footer">
            <div class="footer__container">
                <div class="links">
                    <a href="https://www.instagram.com/skytechdev/?igsh=MXRyZnI2eW9reWp0dg%3D%3D#" class="links_Instagram">Instagram</a>
                    <a href="https://t.me/skytechdev" class="links_Telegram">Telegram</a>
                    <a href="https://www.youtube.com/@skytechdev" class="links_YouTube">YouTube</a>
                </div>
            </div>
        </footer>
    </div>
    <script>
    document.body.addEventListener('click', event => {
        const img = event.target.closest('.post__image');
        if (!img) return;

        const postElem = img.closest('.post');
        if (!postElem) return;

        const postId = postElem.dataset.id;
        if (!postId) return;

        // –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
        window.location.href = `/AircraftSandbox/AircraftSandbox/AircraftSandbox/AircraftSandbox/post.html?post=${encodeURIComponent(postId)}`;
    });
    </script>

    <script>
    document.body.addEventListener('click', event => {
        const btn = event.target.closest('.post__like, .post__dislike');
        if (!btn) return;

        const postId = btn.dataset.id;
        const action = btn.dataset.action;

        fetch('PHP/scripts/updateLikes.php', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
            },
            body: new URLSearchParams({ postId, action }).toString()
        })
        .then(res => res.text().then(txt => {
            const ct = res.headers.get('Content-Type') || '';
            if (res.ok && ct.includes('application/json')) {
                try {
                    return JSON.parse(txt);
                } catch (e) {
                    throw new Error('Invalid JSON: ' + e.message);
                }
            } else {
                throw new Error(`HTTP ${res.status}:\n${txt}`);
            }
        }))
        .then(data => {
            if (!data.success) {
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + data.message);
                return;
            }
            const postElem = btn.closest('.post');
            if (!postElem) return;
            postElem.querySelector('.like-count').textContent    = data.likesCount;
            postElem.querySelector('.dislike-count').textContent = data.dislikesCount;
        })
        .catch(err => {
            console.error('‚ùå Response was not JSON or network error:', err);
            alert('–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞:\n' + err.message);
        });
    });
    </script>
    <script>
       document.addEventListener("DOMContentLoaded", function () {
        document.querySelector('.create-post__form').addEventListener('submit', function (e) {
            e.preventDefault();

            const textarea = this.querySelector('.create-post__textarea');
            const namearea = this.querySelector('.create-post__namearea')
            const fileInput = this.querySelector('.create-post__file');
            const content = textarea.value.trim();
            const name = namearea.value.trim();
            if (content === '') {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç—É.');
                return;
            }

            const formData = new FormData();
            formData.append('header', name);
            formData.append('content', content);
            formData.append('likesCount', 0);
            formData.append('dislikesCount', 0);

            if (fileInput.files.length > 0) {
                formData.append('image', fileInput.files[0]);
            }

            fetch('/AircraftSandbox/AircraftSandbox/AircraftSandbox/AircraftSandbox/PHP/scripts/createPost.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                const container = document.querySelector('.posts-container');
                if (container) {
                    container.insertAdjacentHTML('afterbegin', html);
                } else {
                    console.error("‚ùå –ü–æ–º–∏–ª–∫–∞: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä '.posts-container' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!");
                }

                textarea.value = '';
                fileInput.value = '';
            })
            .catch(error => {
                console.error('–ü–æ–º–∏–ª–∫–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó –ø–æ—Å—Ç–∞:', error);
            });
        });
    });
    </script>
</body>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // –ó–∞—á–µ–∫–∞—î–º–æ, –ø–æ–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–∞—Ç—å—Å—è –ø–æ—Å—Ç–∏
    fetch('/AircraftSandbox/AircraftSandbox/AircraftSandbox/AircraftSandbox/PHP/scripts/loadPosts.php')
        .then(response => response.text())
        .then(html => {
            const container = document.querySelector('.posts-container');
            container.innerHTML = html;

            // –ü—ñ—Å–ª—è –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—è HTML ‚Äî –¥–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –Ω–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
            container.querySelectorAll('.post__image img').forEach(img => {
                img.addEventListener('click', () => {
                    const parent = img.closest('.post');
                    if (parent && parent.dataset.id) {
                        const postId = parent.dataset.id;
                        window.location.href = `post.html?id=${postId}`;
                    }
                });
            });
        });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    fetch('/AircraftSandbox/AircraftSandbox/AircraftSandbox/AircraftSandbox/PHP/scripts/authCheck.php')
        .then(response => response.json())
        .then(data => {
            if (!data.authorized) {
                window.location.href = '/AircraftSandbox/AircraftSandbox/AircraftSandbox/AircraftSandbox/registerAlpha/register.html';
            }
        })
        .catch(error => {
            console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó:', error);
            window.location.href = '/AircraftSandbox/AircraftSandbox/AircraftSandbox/AircraftSandbox/registerAlpha/register.html';
        });
});
</script>
    
<script>
    document.addEventListener("DOMContentLoaded", function () {
      fetch('/AircraftSandbox/AircraftSandbox/AircraftSandbox/AircraftSandbox/PHP/scripts/login_Firebase.php')
        .then(res => res.json())
        .then(user => {
          if (user && user.ImagePath) {
            const avatar = document.getElementById('header-avatar');
            if (avatar) {
              avatar.src = user.ImagePath;
            }
    
            const userProfileLink = document.getElementById('user-profile');
            if (userProfileLink) {
              userProfileLink.style.display = 'inline-block';
            }
    
            const authButton = document.getElementById('auth-button');
            if (authButton) {
              authButton.style.display = 'none';
            }
          }
        })
        .catch(err => {
          console.error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:', err);
        });
    });
    </script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.post__avatar').forEach(img => {
    img.onerror = function () {
      this.onerror = null;
      this.src = '/AircraftSandbox/AircraftSandbox/AircraftSandbox/AircraftSandbox/img/users/default-avatar.png';
    };
  });
});

</script>
<script src="../AircraftSandbox/js/script.js"></script>
<script src="../AircraftSandbox/js/scrollForum.js"></script>
</html>