<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–¢—Ä–µ–¥ –ø–æ—Å—Ç—É</title>
  <link rel="stylesheet" href="../AircraftSandbox/css/style.css"/>
  <link rel="stylesheet" href="css/post.css"/>
</head>
<body>
  <div class="page-wrapper">
    <header class="header">
      <!-- ... (—Ç–≤—ñ–π —Ö–µ–¥–µ—Ä –±–µ–∑ –∑–º—ñ–Ω) ... -->
    </header>

    <main class="main container">
      <section class="post-thread">
        <div class="post-thread__post">
          <h2 class="post-thread__title" id="post-title"></h2>
          <img src="" alt="Post image" class="post-thread__image" id="post-image" style="display:none;">
          <p class="post-thread__text" id="post-text"></p>
          <div class="post-thread__actions">
          <button class="post-thread__like" data-action="like" data-id="">üëç <span class="like-count" id="like-count">0</span></button>
          <button class="post-thread__dislike" data-action="dislike" data-id="">üëé <span class="dislike-count" id="dislike-count">0</span></button>
          </div>
        </div>

        <div class="post-thread__comments">
          <h3 class="post-thread__comments-title">–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ</h3>
          <div id="comments-container">
            <div id="comment-form" style="margin-top: 20px;">
            <textarea id="comment-text" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å —Å–≤—ñ–π –∫–æ–º–µ–Ω—Ç–∞—Ä..." style="width:100%;padding:10px;border-radius:8px;"></textarea>
            <button id="submit-comment" style="margin-top:10px;padding:8px 16px;">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
          </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <!-- ... (—Ç–≤–æ–π —Ñ—É—Ç–µ—Ä –±–µ–∑ –∑–º—ñ–Ω) ... -->
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script src="../AircraftSandbox/js/script.js"></script>
  <script>
    let globalPostId = null;

document.addEventListener("DOMContentLoaded", function () {
  const params = new URLSearchParams(window.location.search);
  const postId = params.get('id');
  globalPostId = postId;

  if (!postId) {
    document.getElementById("post-title").textContent = "‚ùå –ü–æ—Å—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.";
    return;
  }

  fetch(`/AircraftSandbox/AircraftSandbox/AircraftSandbox/AircraftSandbox/PHP/scripts/loadPostById.php?id=${postId}`)
    .then(res => res.json())
    .then(data => {
      if (!data || data.error) {
        document.getElementById("post-title").textContent = "‚ùå –ü–æ—Å—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.";
        return;
      }

      document.getElementById("post-title").textContent = data.header;
      document.getElementById("post-text").textContent = data.content;
      document.getElementById("like-count").textContent = data.likesCount;
      document.getElementById("dislike-count").textContent = data.dislikesCount;

      document.querySelector('.post-thread__like').dataset.id = postId;
      document.querySelector('.post-thread__dislike').dataset.id = postId;

      if (data.imagePath) {
        const img = document.getElementById("post-image");
        img.src = data.imagePath;
        img.style.display = 'block';
      }
    });

  // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
  fetch('/AircraftSandbox/AircraftSandbox/AircraftSandbox/AircraftSandbox/PHP/scripts/getSessionUser.php')
    .then(res => res.json())
    .then(data => {
      if (data.loggedIn) {
        const profileEl = document.getElementById('user-profile');
        if (profileEl) {
          profileEl.style.display = 'block';
          profileEl.title = `–í–∏ —É–≤—ñ–π—à–ª–∏ —è–∫: ${data.login}`;
        }
      }
    });

  // –û–±—Ä–æ–±–∫–∞ –ª–∞–π–∫—ñ–≤ / –¥–∏–∑–ª–∞–π–∫—ñ–≤
  document.querySelectorAll('.post-thread__like, .post-thread__dislike').forEach(button => {
    button.addEventListener('click', () => {
      const action = button.dataset.action;
      const postId = globalPostId;

      fetch('/AircraftSandbox/AircraftSandbox/AircraftSandbox/AircraftSandbox/PHP/scripts/updateLikes.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `postId=${postId}&action=${action}`
      })
      .then(res => res.json())
      .then(result => {
        if (result.success) {
          document.getElementById('like-count').textContent = result.likesCount;
          document.getElementById('dislike-count').textContent = result.dislikesCount;
        } else {
          console.warn("‚ö†Ô∏è", result.message || '–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Ä–µ–∞–∫—Ü—ñ—é');
        }
      });
    });
  });
});
  </script>
  <script>
function loadComments(postId) {
  fetch(`/AircraftSandbox/AircraftSandbox/AircraftSandbox/AircraftSandbox/PHP/scripts/loadComments.php?postId=${postId}`)
    .then(res => res.json())
    .then(comments => {
      const container = document.getElementById('comments-container');
      container.innerHTML = '';
      if (!comments.length) {
        container.innerHTML = '<p>–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î.</p>';
        return;
      }

      comments.forEach(c => {
        const el = document.createElement('div');
        el.className = 'comment';
        el.innerHTML = `
          <div class="comment__inner">
            <div>
              <p class="comment__user">${c.UserLogin}</p>
              <p class="comment__text">${c.CommentText}</p>
              <small>${c.CommentDate}</small>
            </div>
          </div>
        `;
        container.appendChild(el);
      });
    });
}

document.addEventListener('DOMContentLoaded', () => {
  const postId = globalPostId;
  loadComments(postId);

  document.getElementById('submit-comment')?.addEventListener('click', () => {
    const text = document.getElementById('comment-text').value.trim();
    if (!text) return;

    fetch('/AircraftSandbox/AircraftSandbox/AircraftSandbox/AircraftSandbox/PHP/scripts/addComment.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `postId=${postId}&comment=${encodeURIComponent(text)}`
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.getElementById('comment-text').value = '';
        loadComments(postId);
      } else {
        alert(data.message || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ –∫–æ–º–µ–Ω—Ç–∞—Ä—è');
      }
    });
  });
});
</script>
</body>
<script>
document.addEventListener('DOMContentLoaded', () => {
    fetch('/AircraftSandbox/AircraftSandbox/AircraftSandbox/AircraftSandbox/PHP/scripts/authCheck.php')
        .then(response => response.json())
        .then(data => {
            if (!data.authorized) {
                window.location.href = '/AircraftSandbox/AircraftSandbox/AircraftSandbox/AircraftSandbox/registerAlpha/register.html';
            }
        })
        .catch(error => {
            console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó:', error);
            // –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
            window.location.href = '/AircraftSandbox/AircraftSandbox/AircraftSandbox/AircraftSandbox/registerAlpha/register.html';
        });
});
</script>


</html>